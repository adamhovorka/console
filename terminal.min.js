/*
**  terminal.js - v2.0.0-rc.1
**
**  A pixel-perfect JavaScript terminal
**  [>] Because I wanted one.
**
**  (i) Requires Dot >=2.1.1: https://github.com/adamhovorka/dot
**  (i) Requires font.js (included in repository)
**
**  Copyleft @ 2014 Adam Hovorka - All Rights Reversed
*/Terminal=function(){function s(e,t){return function(){e.apply(t,arguments)}}function o(e){return JSON.parse(JSON.stringify(e))}function u(t,n,r,i,s,o,u){var a=u.width,f=u.height;r=u.get(parseInt(r,16)),o.setColor(e[s]).rectf(n*a,t*f,n*a+a-1,t*f+f-1).setColor(e[i]);for(var l=0;l<r.length;l++)for(var c=0;c<r[l].length;c++)r[l][c]&&o.dot(f*t+l,a*n+c)}var e=["#000000","#cd0000","#00cd00","#cdcd00","#0000ee","#cd00cd","#00cdcd","#e5e5e5","#7f7f7f","#ff0000","#00ff00","#ffff00","#5c5cff","#ff00ff","#00ffff","#ffffff"],t={" ":"20","!":"21",'"':"22","#":"23",$:"24","%":"25","&":"26","'":"27","(":"28",")":"29","*":"2a","+":"2b",",":"2c","-":"2d",".":"2e","/":"2f",0:"30",1:"31",2:"32",3:"33",4:"34",5:"35",6:"36",7:"37",8:"38",9:"39",":":"3a",";":"3b","<":"3c","=":"3d",">":"3e","?":"3f","@":"40",A:"41",B:"42",C:"43",D:"44",E:"45",F:"46",G:"47",H:"48",I:"49",J:"4a",K:"4b",L:"4c",M:"4d",N:"4e",O:"4f",P:"50",Q:"51",R:"52",S:"53",T:"54",U:"55",V:"56",W:"57",X:"58",Y:"59",Z:"5a","[":"5b","\\":"5c","]":"5d","^":"5e",_:"5f","`":"60",a:"61",b:"62",c:"63",d:"64",e:"65",f:"66",g:"67",h:"68",i:"69",j:"6a",k:"6b",l:"6c",m:"6d",n:"6e",o:"6f",p:"70",q:"71",r:"72",s:"73",t:"74",u:"75",v:"76",w:"77",x:"78",y:"79",z:"7a","{":"7b","|":"7c","}":"7d","~":"7e"},n={};for(i in t)n[t[i]]=i;var r={c:"00",k:"07"};return function(e,n){this.setCA=function(e){return typeof e=="string"?this._dot.setCA(document.getElementById(e)):this._dot.setCA(e),this},this.setX=function(e){return this._dot.setX(e),this},this.setFont=function(e,t){return this._rb=this.blockRender,this.blockRender=!0,this._font=new Font(e,s(function(e){this.blockRender=this._rb,this.render(),t&&t()},this)),this},this.height=function(){return Math.floor(this._dot.height()/(this._font.height*this._dot._x))},this.width=function(){return Math.floor(this._dot.width()/(this._font.width*this._dot._x))},this.size=function(){return{h:this.height(),w:this.width()}},this.draw=function(e,t){if(this._frame[e][t].c!=this._prevFrame[e][t].c||this._frame[e][t].k!=this._prevFrame[e][t].k){var n=this._frame[e][t];u(e,t,n.c,parseInt(n.k.charAt(1),16),parseInt(n.k.charAt(0),16),this._dot,this._font),this._prevFrame[e][t]=o(n)}return this},this.render=function(){for(var e=0;e<24;e++)for(var t=0;t<80;t++)this.draw(e,t);return this},this.set=function(e,t,n,r){return n&&(this._frame[e][t].c=n),r&&(this._frame[e][t].k=r),this.blockRender||this.draw(e,t),this},this.get=function(e,t){return this._frame[e][t]},this.copyLine=function(e){var t="";for(var n=0;n<80;n++){var r=this.get(e,n);t+="%k"+r.k,t+="%"+r.c}return this._lcb.push(t),this},this.pasteLine=function(e){return this.push().position(e,0).write(this._lcb.pop()).pop(),this},this.position=function(e,t){return e==undefined?{x:this._cur.x,y:this._cur.y}:(t!=undefined&&t!=null&&(this._cur.x=t),e!=null&&(this._cur.y=e),this)},this.move=function(e,t){return this._cur.x+=t,this._cur.x>79&&(this._cur.x-=80,this._cur.y++),this._cur.x<0&&(this._cur.x+=80,this._cur.y--),this._cur.y+=e,this._cur.y>23&&(this._cur.y-=24),this._cur.y<0&&(this._cur.y+=24),this},this.up=function(e){return this.move(-e,0),this},this.down=function(e){return this.move(e,0),this},this.left=function(e){return this.move(0,-e),this},this.right=function(e){return this.move(0,e),this},this.push=function(){return this._curs.push(o(this._cur)),this},this.pop=function(){return this._cur=this._curs.pop(),this},this.k=function(e){return e!=undefined?(this._cur.k=e,this):this._cur.k},this.fg=function(e){return e!=undefined?(this._cur.k=this.bg()+e,this):this._cur.k.charAt(1)},this.bg=function(e){return e!=undefined?(this._cur.k=e+this.fg(),this):this._cur.k.charAt(0)},this.write=function(e){var n=(e+"").split("");for(var r=0;r<n.length;r++){var i=n[r];if(i=="%"){if(n[r+1]=="n"){this._cur.y++,r++;continue}if(n[r+1]=="r"){this._cur.x=0,r++;continue}if(n[r+1]=="k"){this._cur.k=n[r+2]+n[r+3],r+=3;continue}if(n[r+1]=="%"){var s=t["%"];r+=1}else{var s=n[r+1]+n[r+2];r+=2}}else var s=t[i];this.set(this._cur.y,this._cur.x,s,this._cur.k).right(1)}return this},this.writeAt=function(e,t,n){return this.push().position(e,t).write(n).pop(),this},this.moveLine=function(e,t){return this.copyLine(e).pasteLine(t),this},this.insertLine=function(e){for(var t=23;t>e;t--)this.moveLine(t-1,t);return this},this.deleteLine=function(e){for(var t=e;t<23;t++)this.moveLine(t+1,t);return this.eraseLine(23),this},this.eraseLine=function(e,t){for(var n=0;n<80;n++)this.set(e,n,"00",t||"07");return this},this.erase=function(e){if(e=="end")for(var t=this._cur.x;t<80;t++)this.set(this._cur.y,t,"00","07");else if(e=="start")for(var t=0;t<=this._cur.x;t++)this.set(this._cur.y,t,"00","07");else if(e=="line")this.eraseLine(this._cur.y);else if(e=="down")for(var t=this._cur.y;t<24;t++)this.eraseLine(t);else if(e=="up")for(var t=0;t<=this._cur.y;t++)this.eraseLine(t);else e=="screen"&&this.reset();return this},this.del=function(e,t){if(e=="line")for(var n=0;n<t;n++)this.deleteLine(this._cur.y);else if(e=="char"){for(var n=this._cur.x+t;n<80;n++){var r=this.get(this._cur.y,n);this.set(this._cur.y,n-t,r.c,r.k)}for(var n=80-t;n<80;n++)this.set(this._cur.y,n,"00","07")}return this},this.ins=function(e,t){if(e=="line")for(var n=0;n<t;n++)this.insertLine(this._cur.y);else if(e=="char"){for(var n=79;n>=this._cur.x+t;n--){var r=this.get(this._cur.y,n-t);this.set(this._cur.y,n,r.c,r.k)}for(var n=this._cur.x;n<this._cur.x+t;n++)this.set(this._cur.y,n,"00","07")}return this},this.backspace=function(){return this.left(1).del("char",1),this},this.reset=function(){this._dot.clear(),this._frame=[];var e=this.size();for(var t=0;t<e.h;t++){this._frame.push([]);for(var n=0;n<e.w;n++)this._frame[t].push(o(r))}return this._prevFrame=o(this._frame),this},this._dot=new Dot,e&&this.setCA(e),this._cur={x:0,y:0,k:"07"},this._curs=[],this._lcb=[],this.blockRender=!0,this._font=new Font("font.png",s(function(e){this.blockRender=!1,this.render(),n&&n()},this)),this.reset()}}();